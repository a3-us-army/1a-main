<!DOCTYPE html>
<html>
  <head>
    <title>Database Table: <%= tableName %> - 1A 75th</title>
    <meta content="1A Website" property="og:title" />
    <meta content="Welcome to 1A!" property="og:description" />
    <meta content="https://1a75.org/database-editor" property="og:url" />
    <meta content="https://cdn.xanderxx.xyz/1a-logo.png" property="og:image" />
    <meta content="#4b5a2a" data-react-helmet="true" name="theme-color" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/custom.css" />
  </head>
  <body>
    <%- include('../partials/navbar', { user, active }) %>
    <div class="container mt-5">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2 mb-0">Table: <%= tableName %></h1>
        <div class="d-flex gap-2">
          <a href="/database-editor" class="btn btn-outline-primary">
            <i class="bi bi-arrow-left me-2"></i>Back to Editor
          </a>
          <a href="/database-editor/table/<%= tableName %>/add" class="btn btn-primary">
            <i class="bi bi-plus-circle me-2"></i>Add Row
          </a>
        </div>
      </div>

      <% if (alert) { %>
        <div class="alert alert-success alert-dismissible fade show" role="alert">
          <%= alert %>
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      <% } %>

      <% if (error) { %>
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <%= error %>
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      <% } %>

      <!-- Table Info -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title mb-0">Table Information</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <p><strong>Table Name:</strong> <%= tableName %></p>
              <p><strong>Total Rows:</strong> <%= pagination.totalCount.toLocaleString() %></p>
            </div>
            <div class="col-md-6">
              <p><strong>Columns:</strong> <%= schema.length %></p>
              <p><strong>Current Page:</strong> <%= pagination.currentPage %> of <%= pagination.totalPages %></p>
            </div>
          </div>
        </div>
      </div>

      <!-- Pagination Controls -->
      <% if (pagination.totalPages > 1) { %>
        <div class="card mb-4">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                Showing <%= ((pagination.currentPage - 1) * pagination.limit) + 1 %> to 
                <%= Math.min(pagination.currentPage * pagination.limit, pagination.totalCount) %> 
                of <%= pagination.totalCount.toLocaleString() %> entries
              </div>
              <div class="d-flex gap-2">
                <% if (pagination.currentPage > 1) { %>
                  <a href="?page=<%= pagination.currentPage - 1 %>&limit=<%= pagination.limit %>" class="btn btn-outline-primary">
                    <i class="bi bi-chevron-left"></i> Previous
                  </a>
                <% } %>
                <% if (pagination.currentPage < pagination.totalPages) { %>
                  <a href="?page=<%= pagination.currentPage + 1 %>&limit=<%= pagination.limit %>" class="btn btn-outline-primary">
                    Next <i class="bi bi-chevron-right"></i>
                  </a>
                <% } %>
              </div>
            </div>
          </div>
        </div>
      <% } %>

      <!-- Table Data -->
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">Table Data</h5>
        </div>
        <div class="card-body p-0">
          <% if (data.length > 0) { %>
            <div class="table-responsive">
              <table class="table table-dark table-hover mb-0">
                <thead>
                  <tr>
                    <% schema.forEach(column => { %>
                      <th>
                        <%= column.name %>
                        <% if (column.pk > 0) { %>
                          <i class="bi bi-key text-warning ms-1" title="Primary Key"></i>
                        <% } %>
                      </th>
                    <% }) %>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% data.forEach(row => { %>
                    <tr>
                      <% schema.forEach(column => { %>
                        <td>
                          <% if (row[column.name] === null || row[column.name] === undefined) { %>
                            <span class="text-muted">NULL</span>
                          <% } else if (typeof row[column.name] === 'boolean') { %>
                            <span class="badge <%= row[column.name] ? 'bg-success' : 'bg-secondary' %>">
                              <%= row[column.name] ? 'True' : 'False' %>
                            </span>
                          <% } else if (column.type === 'TEXT' && row[column.name].length > 50) { %>
                            <span title="<%= row[column.name] %>">
                              <%= row[column.name].substring(0, 50) %>...
                            </span>
                          <% } else { %>
                            <%= row[column.name] %>
                          <% } %>
                        </td>
                      <% }) %>
                      <td>
                        <div class="btn-group btn-group-sm">
                          <% 
                            const primaryKey = schema.find(col => col.pk > 0);
                            const primaryKeyValue = primaryKey ? row[primaryKey.name] : null;
                          %>
                          <% if (primaryKeyValue) { %>
                            <a href="/database-editor/table/<%= tableName %>/edit/<%= primaryKeyValue %>" class="btn btn-outline-primary">
                              <i class="bi bi-pencil"></i>
                            </a>
                            <form method="POST" action="/database-editor/table/<%= tableName %>/delete/<%= primaryKeyValue %>" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this row?')">
                              <button type="submit" class="btn btn-outline-danger">
                                <i class="bi bi-trash"></i>
                              </button>
                            </form>
                          <% } else { %>
                            <span class="text-muted">No PK</span>
                          <% } %>
                        </div>
                      </td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          <% } else { %>
            <div class="text-center py-5">
              <i class="bi bi-table text-muted" style="font-size: 3rem;"></i>
              <p class="text-muted mt-3">No data found in this table</p>
              <a href="/database-editor/table/<%= tableName %>/add" class="btn btn-primary">
                <i class="bi bi-plus-circle me-2"></i>Add Your First Row
              </a>
            </div>
          <% } %>
        </div>
      </div>

      <!-- Page Size Controls -->
      <div class="card mt-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <label for="limit" class="form-label me-2">Rows per page:</label>
              <select id="limit" class="form-select d-inline-block" style="width: auto;" onchange="changeLimit(this.value)">
                <option value="25" <%= pagination.limit === 25 ? 'selected' : '' %>>25</option>
                <option value="50" <%= pagination.limit === 50 ? 'selected' : '' %>>50</option>
                <option value="100" <%= pagination.limit === 100 ? 'selected' : '' %>>100</option>
                <option value="250" <%= pagination.limit === 250 ? 'selected' : '' %>>250</option>
              </select>
            </div>
            <div>
              <a href="/database-editor" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i>Back to Database Editor
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <%- include('../partials/footer') %>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      function changeLimit(limit) {
        const url = new URL(window.location);
        url.searchParams.set('limit', limit);
        url.searchParams.set('page', '1'); // Reset to first page
        window.location.href = url.toString();
      }
    </script>
  </body>
</html> 