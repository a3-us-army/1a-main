<!DOCTYPE html>
<html>
  <head>
    <title>Form Responses - <%= form.name %> - 1A 75th</title>
    <meta content="1A Website" property="og:title" />
    <meta content="Welcome to 1A!" property="og:description" />
    <meta content="https://1a75.org/form-builder" property="og:url" />
    <meta content="https://cdn.xanderxx.xyz/1a-logo.png" property="og:image" />
    <meta content="#4b5a2a" data-react-helmet="true" name="theme-color" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/custom.css" />
  </head>
  <body>
    <%- include('../partials/navbar', { user, active }) %>
    <div class="container mt-5">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2 mb-0">Form Responses - <%= form.name %></h1>
        <div class="d-flex gap-2">
          <a href="/form-builder" class="btn btn-outline-primary">
            <i class="bi bi-arrow-left me-2"></i>Back to Forms
          </a>
          <button class="btn btn-outline-success" onclick="exportResponses()">
            <i class="bi bi-download me-2"></i>Export CSV
          </button>
        </div>
      </div>

      <% if (alert) { %>
        <div class="alert alert-success alert-dismissible fade show" role="alert">
          <%= alert %>
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      <% } %>

      <!-- Form Info -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title mb-0">Form Information</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <p><strong>Form Name:</strong> <%= form.name %></p>
              <p><strong>Description:</strong> <%= form.description || 'No description' %></p>
              <p><strong>Status:</strong> 
                <% if (form.is_active) { %>
                  <span class="badge bg-success">Active</span>
                <% } else { %>
                  <span class="badge bg-secondary">Inactive</span>
                <% } %>
              </p>
            </div>
            <div class="col-md-6">
              <p><strong>Total Responses:</strong> <%= responses.length %></p>
              <p><strong>Created:</strong> <%= new Date(form.created_at).toLocaleDateString() %></p>
              <% if (form.max_responses) { %>
                <p><strong>Max Responses:</strong> <%= form.max_responses %></p>
              <% } %>
              <% if (form.expiry_date) { %>
                <p><strong>Expires:</strong> <%= new Date(form.expiry_date).toLocaleDateString() %></p>
              <% } %>
            </div>
          </div>
        </div>
      </div>

      <!-- Filters -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title mb-0">Filters</h5>
        </div>
        <div class="card-body">
          <form method="GET" class="row g-3">
            <div class="col-md-4">
              <label for="date_from" class="form-label">Date From</label>
              <input type="date" class="form-control" id="date_from" name="date_from" value="<%= filters.date_from || '' %>">
            </div>
            <div class="col-md-4">
              <label for="date_to" class="form-label">Date To</label>
              <input type="date" class="form-control" id="date_to" name="date_to" value="<%= filters.date_to || '' %>">
            </div>
            <div class="col-md-4">
              <label for="search" class="form-label">Search</label>
              <input type="text" class="form-control" id="search" name="search" value="<%= filters.search || '' %>" placeholder="Search responses...">
            </div>
            <div class="col-12">
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-search me-2"></i>Apply Filters
              </button>
              <a href="/form-builder/responses/<%= form.id %>" class="btn btn-outline-secondary">
                <i class="bi bi-x-circle me-2"></i>Clear Filters
              </a>
            </div>
          </form>
        </div>
      </div>

      <!-- Responses Table -->
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">Form Responses</h5>
        </div>
        <div class="card-body p-0">
          <% if (responses.length > 0) { %>
            <div class="table-responsive">
              <table class="table table-dark table-hover mb-0">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Submitted</th>
                    <% form.fields.forEach(field => { %>
                      <th><%= field.label %></th>
                    <% }) %>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% responses.forEach((response, index) => { %>
                    <tr>
                      <td><%= index + 1 %></td>
                      <td>
                        <small>
                          <% 
                            const responseDate = response.completed_at || response.created_at || response.started_at;
                            if (responseDate) { %>
                              <%= new Date(responseDate).toLocaleDateString() %><br>
                              <%= new Date(responseDate).toLocaleTimeString() %>
                            <% } else { %>
                              <span class="text-muted">No date</span>
                            <% } %>
                        </small>
                      </td>
                      <% form.fields.forEach(field => { %>
                        <td>
                          <% 
                            const fieldValue = response.data[field.name];
                            if (fieldValue === null || fieldValue === undefined) { %>
                              <span class="text-muted">-</span>
                            <% } else if (field.type === 'file' && fieldValue) { %>
                              <a href="<%= fieldValue %>" target="_blank" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-download me-1"></i>Download
                              </a>
                            <% } else if (Array.isArray(fieldValue)) { %>
                              <span class="badge bg-info"><%= fieldValue.join(', ') %></span>
                            <% } else if (typeof fieldValue === 'string' && fieldValue.length > 50) { %>
                              <span title="<%= fieldValue %>">
                                <%= fieldValue.substring(0, 50) %>...
                              </span>
                            <% } else { %>
                              <%= fieldValue %>
                            <% } %>
                        </td>
                      <% }) %>
                      <td>
                        <div class="d-flex gap-2">
                          <button class="btn btn-outline-info btn-sm" onclick="viewResponse('<%= response.id %>')" title="View Response Details">
                            <i class="bi bi-eye me-1"></i>View
                          </button>
                          <form method="POST" action="/form-builder/responses/<%= form.id %>/delete/<%= response.id %>" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this response? This action cannot be undone.')">
                            <button type="submit" class="btn btn-outline-danger btn-sm" title="Delete Response">
                              <i class="bi bi-trash me-1"></i>Delete
                            </button>
                          </form>
                        </div>
                      </td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          <% } else { %>
            <div class="text-center py-5">
              <i class="bi bi-chat-dots text-muted" style="font-size: 3rem;"></i>
              <p class="text-muted mt-3">No responses yet</p>
              <a href="/form/<%= form.id %>" target="_blank" class="btn btn-primary">
                <i class="bi bi-eye me-2"></i>View Form
              </a>
            </div>
          <% } %>
        </div>
      </div>

      <!-- Response Details Modal -->
      <div class="modal fade" id="responseModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Response Details</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="responseModalBody">
              <!-- Response details will be loaded here -->
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <%- include('../partials/footer') %>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      function viewResponse(responseId) {
        // Load response details via AJAX
        fetch(`/form-builder/responses/<%= form.id %>/view/${responseId}`)
          .then(response => response.json())
          .then(data => {
            const modalBody = document.getElementById('responseModalBody');
            modalBody.innerHTML = data.html;
            new bootstrap.Modal(document.getElementById('responseModal')).show();
          })
          .catch(error => {
            console.error('Error loading response:', error);
            alert('Error loading response details');
          });
      }

      function exportResponses() {
        const params = new URLSearchParams(window.location.search);
        const exportUrl = `/form-builder/responses/<%= form.id %>/export?${params.toString()}`;
        window.location.href = exportUrl;
      }
    </script>
  </body>
</html> 