<!DOCTYPE html>
<html>
  <head>
    <title>Staff Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/custom.css">
  </head>
  <body>
    <%- include("../partials/navbar", { user, active }) %>
    <main class="container py-4">
      <h1 class="h3">Staff Admin</h1>
      <% if (alert) { %><div class="alert alert-success"><%= alert %></div><% } %>
      <% if (error) { %><div class="alert alert-danger"><%= error %></div><% } %>
      <form class="row g-2" method="post" action="/staff-admin/add">
        <div class="col-md-5">
          <input class="form-control" name="discord_id" placeholder="Discord User ID" required />
        </div>
        <div class="col-md-5">
          <input class="form-control" name="title" placeholder="Title (e.g., Web Admin)" />
        </div>
        <div class="col-md-2 d-grid">
          <button class="btn btn-primary" type="submit">Add</button>
        </div>
      </form>
      <hr />
      <div class="table-responsive">
        <table class="table table-dark table-striped align-middle" id="staff-table">
          <thead>
            <tr>
              <th style="width:36px"></th>
              <th>User ID</th><th>Title</th><th>Description</th><th>Image</th><th></th>
            </tr>
          </thead>
          <tbody id="staff-tbody">
            <% profiles.forEach(p => { %>
              <tr data-id="<%= p.id %>">
                <td class="text-center align-middle"><i class="bi bi-grip-vertical" style="cursor: grab;"></i></td>
                <td><code><%= p.user_id %></code></td>
                <td><%= p.title || '' %></td>
                <td style="max-width: 360px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                  <%= p.description || '' %>
                </td>
                <td>
                  <% if (p.image_filename) { %>
                    <img src="/uploads/staff/<%= p.image_filename %>" alt="img" style="height:48px; border-radius:6px;" />
                  <% } %>
                </td>
                <td class="text-end">
                  <div class="btn-group">
                    <a class="btn btn-sm btn-outline-secondary" href="/staff-admin/edit/<%= p.id %>"><i class="bi bi-pencil"></i> Edit</a>
                    <form method="post" action="/staff-admin/delete/<%= p.id %>" onsubmit="return confirm('Remove this staff member?');">
                      <button class="btn btn-sm btn-outline-danger" type="submit">Remove</button>
                    </form>
                  </div>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
        <div class="text-end">
          <button id="save-order" class="btn btn-primary btn-sm"><i class="bi bi-save"></i> Save Order</button>
        </div>
      </div>
      <script>
        // Simple drag-and-drop reordering using HTML5 API
        const tbody = document.getElementById('staff-tbody');
        let dragEl = null;

        function onDragStart(e) {
          dragEl = e.currentTarget;
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', dragEl.dataset.id);
          dragEl.classList.add('opacity-50');
        }
        function onDragOver(e) {
          e.preventDefault();
          const target = e.target.closest('tr');
          if (!target || target === dragEl) return;
          const rect = target.getBoundingClientRect();
          const next = (e.clientY - rect.top) / (rect.bottom - rect.top) > 0.5;
          tbody.insertBefore(dragEl, next ? target.nextSibling : target);
        }
        function onDragEnd(e) {
          if (dragEl) dragEl.classList.remove('opacity-50');
          dragEl = null;
        }
        Array.from(tbody.querySelectorAll('tr')).forEach(row => {
          row.draggable = true;
          row.addEventListener('dragstart', onDragStart);
          row.addEventListener('dragover', onDragOver);
          row.addEventListener('dragend', onDragEnd);
        });
        document.getElementById('save-order').addEventListener('click', async () => {
          const ids = Array.from(tbody.querySelectorAll('tr')).map(tr => tr.dataset.id);
          const res = await fetch('/staff-admin/reorder', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ order: ids })
          });
          if (res.ok) {
            alert('Order saved');
          } else {
            alert('Failed to save order');
          }
        });
      </script>
    </main>
  </body>
  </html>


