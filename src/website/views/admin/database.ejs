<!DOCTYPE html>
<html>
  <head>
    <title>Database Health - 1A 75th</title>
    <meta content="1A Website" property="og:title" />
    <meta content="Welcome to 1A!" property="og:description" />
    <meta content="https://1a75.org/admin/database" property="og:url" />
    <meta content="https://cdn.xanderxx.xyz/1a-logo.png" property="og:image" />
    <meta content="#4b5a2a" data-react-helmet="true" name="theme-color" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/custom.css" />
  </head>
  <body>
    <%- include('../partials/navbar', { user, active }) %>
    <div class="container mt-5">
      <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="h2 mb-0">Database Health</h1>
      <div class="d-flex gap-2">
        <form method="POST" action="/database-health/health-check" class="d-inline">
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-circle me-2"></i>Run Health Check
          </button>
        </form>
        <form method="POST" action="/database-health/optimize" class="d-inline">
          <button type="submit" class="btn btn-success">
            <i class="bi bi-gear me-2"></i>Optimize Database
          </button>
        </form>
        <form method="POST" action="/database-health/backup" class="d-inline">
          <button type="submit" class="btn btn-warning">
            <i class="bi bi-download me-2"></i>Create Backup
          </button>
        </form>
        <button type="button" class="btn btn-info" onclick="loadBackups()">
          <i class="bi bi-folder me-2"></i>View Backups
        </button>
      </div>
    </div>

      <% if (alert) { %>
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        <%= alert %>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    <% } %>

    <% if (error) { %>
      <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <%= error %>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    <% } %>

    <!-- Database Overview -->
    <div class="row mb-4">
      <div class="col-md-3 mb-3">
        <div class="card text-center">
          <div class="card-body">
            <h5 class="card-title">Overall Health</h5>
            <p class="h2 <%= overallHealth >= 80 ? 'text-success' : overallHealth >= 60 ? 'text-warning' : 'text-danger' %> mb-0">
              <%= overallHealth %>%
            </p>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card text-center">
          <div class="card-body">
            <h5 class="card-title">Total Tables</h5>
            <p class="h2 text-primary mb-0"><%= healthSummary.length %></p>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card text-center">
          <div class="card-body">
            <h5 class="card-title">Database Size</h5>
            <p class="h2 text-info mb-0">
              <%= (dbStats.size / 1024 / 1024).toFixed(2) %> MB
            </p>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card text-center">
          <div class="card-body">
            <h5 class="card-title">Total Records</h5>
            <p class="h2 text-warning mb-0">
              <%= tableSizes.reduce((sum, table) => sum + table.recordCount, 0).toLocaleString() %>
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Table Health -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="card-title mb-0">Table Health</h5>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-dark table-hover mb-0">
            <thead>
              <tr>
                <th>Table Name</th>
                <th>Records</th>
                <th>Columns</th>
                <th>Health Score</th>
                <th>Status</th>
                <th>Issues</th>
              </tr>
            </thead>
            <tbody>
              <% healthSummary.forEach(table => { %>
                <tr>
                  <td class="fw-bold"><%= table.tableName %></td>
                  <td><%= table.recordCount.toLocaleString() %></td>
                  <td><%= table.columnCount %></td>
                  <td>
                    <div class="d-flex align-items-center">
                      <div class="progress me-2" style="width: 60px; height: 6px;">
                        <div class="progress-bar <%= table.healthScore >= 80 ? 'bg-success' : table.healthScore >= 60 ? 'bg-warning' : 'bg-danger' %>" 
                             style="width: <%= table.healthScore %>%"></div>
                      </div>
                      <small class="<%= table.healthScore >= 80 ? 'text-success' : table.healthScore >= 60 ? 'text-warning' : 'text-danger' %>">
                        <%= table.healthScore %>%
                      </small>
                    </div>
                  </td>
                  <td>
                    <% if (table.healthScore >= 80) { %>
                      <span class="badge bg-success">Healthy</span>
                    <% } else if (table.healthScore >= 60) { %>
                      <span class="badge bg-warning">Warning</span>
                    <% } else { %>
                      <span class="badge bg-danger">Critical</span>
                    <% } %>
                  </td>
                  <td>
                    <% if (table.issues && table.issues.length > 0) { %>
                      <button class="btn btn-sm btn-outline-warning" 
                              onclick="showIssues('<%= table.tableName %>', '<%= table.issues.join('|').replace(/'/g, "\\'") %>')">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        <%= table.issues.length %> issue<%= table.issues.length !== 1 ? 's' : '' %>
                      </button>
                    <% } else { %>
                      <span class="text-success">
                        <i class="bi bi-check-circle me-1"></i>No issues
                      </span>
                    <% } %>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Table Sizes -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="card-title mb-0">Table Sizes</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <% tableSizes.forEach(table => { %>
            <div class="col-md-6 col-lg-4 mb-3">
              <div class="card">
                <div class="card-body">
                  <h6 class="card-title"><%= table.name %></h6>
                  <p class="card-text text-muted mb-1">
                    <%= table.recordCount.toLocaleString() %> records
                  </p>
                  <p class="card-text text-muted mb-1">
                    <%= table.columnCount %> columns
                  </p>
                  <p class="card-text text-muted">
                    ~<%= (table.estimatedSize / 1024).toFixed(2) %> KB
                  </p>
                </div>
              </div>
            </div>
          <% }) %>
        </div>
      </div>
    </div>

    <!-- Recent Health Logs -->
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">Recent Health Logs</h5>
      </div>
      <div class="card-body p-0">
        <% if (healthLogs.length > 0) { %>
          <div class="list-group list-group-flush">
            <% healthLogs.forEach(log => { %>
              <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <p class="mb-0 fw-bold">
                    <%= log.table_name %>
                  </p>
                  <small class="text-muted">
                    <%= log.record_count.toLocaleString() %> records - 
                    Health: <%= log.health_score %>% - 
                    <%= new Date(log.last_updated).toLocaleString() %>
                  </small>
                </div>
                <div>
                  <% if (log.health_score >= 80) { %>
                    <span class="badge bg-success">Good</span>
                  <% } else if (log.health_score >= 60) { %>
                    <span class="badge bg-warning">Warning</span>
                  <% } else { %>
                    <span class="badge bg-danger">Critical</span>
                  <% } %>
                </div>
              </div>
            <% }) %>
          </div>
        <% } else { %>
          <div class="text-center py-5">
            <i class="bi bi-clipboard-data text-muted" style="font-size: 3rem;"></i>
            <p class="text-muted mt-3">No health logs available</p>
          </div>
        <% } %>
      </div>
    </div>
    </div>
    <!-- Issues Modal -->
    <div class="modal fade" id="issuesModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Database Issues</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="issuesModalBody">
            <!-- Issues will be loaded here -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Backups Modal -->
    <div class="modal fade" id="backupsModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Database Backups</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="backupsModalBody">
            <div class="text-center">
              <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <%- include('../partials/footer') %>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      function showIssues(tableName, issuesString) {
        const issues = issuesString.split('|');
        const modalBody = document.getElementById('issuesModalBody');
        
        let html = `<h6>Issues for table: <strong>${tableName}</strong></h6><ul class="list-group list-group-flush">`;
        issues.forEach(issue => {
          html += `<li class="list-group-item text-danger"><i class="bi bi-exclamation-triangle me-2"></i>${issue}</li>`;
        });
        html += '</ul>';
        
        modalBody.innerHTML = html;
        new bootstrap.Modal(document.getElementById('issuesModal')).show();
      }

      async function loadBackups() {
        const modalBody = document.getElementById('backupsModalBody');
        modalBody.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';
        
        new bootstrap.Modal(document.getElementById('backupsModal')).show();
        
        try {
          const response = await fetch('/database-health/backups');
          const backups = await response.json();
          
          if (backups.length === 0) {
            modalBody.innerHTML = '<div class="text-center text-muted"><i class="bi bi-folder-x" style="font-size: 3rem;"></i><p class="mt-3">No backups found</p></div>';
            return;
          }
          
          let html = '<div class="table-responsive"><table class="table table-hover"><thead><tr><th>Backup Name</th><th>Size</th><th>Created</th><th>Actions</th></tr></thead><tbody>';
          
          backups.forEach(backup => {
            const size = (backup.size / 1024 / 1024).toFixed(2);
            const created = new Date(backup.created).toLocaleString();
            
            html += `
              <tr>
                <td><i class="bi bi-file-earmark-database me-2"></i>${backup.name}</td>
                <td>${size} MB</td>
                <td>${created}</td>
                <td>
                  <button class="btn btn-sm btn-outline-danger" onclick="deleteBackup('${backup.name}')" title="Delete Backup">
                    <i class="bi bi-trash"></i>
                  </button>
                </td>
              </tr>
            `;
          });
          
          html += '</tbody></table></div>';
          modalBody.innerHTML = html;
        } catch (error) {
          console.error('Error loading backups:', error);
          modalBody.innerHTML = '<div class="alert alert-danger">Failed to load backups</div>';
        }
      }

      async function deleteBackup(filename) {
        if (!confirm('Are you sure you want to delete this backup?')) {
          return;
        }
        
        try {
          const response = await fetch(`/database-health/backup/${filename}`, {
            method: 'DELETE'
          });
          
          if (response.ok) {
            loadBackups(); // Reload the list
          } else {
            alert('Failed to delete backup');
          }
        } catch (error) {
          console.error('Error deleting backup:', error);
          alert('Failed to delete backup');
        }
      }
    </script>
  </body>
</html> 