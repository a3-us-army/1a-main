<!DOCTYPE html>
<html>
  <head>
    <title>Edit Application Form</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/custom.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <style>
      #editor {
        height: 600px;
        font-family: monospace;
        font-size: 14px;
      }
      .preview-container {
        border: 1px solid #ccc;
        border-radius: 5px;
        padding: 20px;
        margin-top: 20px;
        background-color: #f8f9fa;
      }
      .json-error {
        color: #dc3545;
        font-family: monospace;
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body>
    <%- include("../partials/navbar", { user, active }) %>
    <div id="main-content">
      <div class="container mt-4">
        <% if (query && query.alert) { %>
        <div
          class="alert alert-success alert-dismissible fade show mt-3"
          role="alert"
        >
          <%= query.alert %>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="alert"
            aria-label="Close"
          ></button>
        </div>
        <% } %>
        <% if (query && query.error) { %>
        <div
          class="alert alert-danger alert-dismissible fade show mt-3"
          role="alert"
        >
          <%= query.error %>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="alert"
            aria-label="Close"
          ></button>
        </div>
        <% } %>

        <div class="row">
          <div class="col-12">
            <div class="card shadow-lg mb-4">
              <div class="card-header bg-primary text-white">
                <h3 class="mb-0">
                  <i class="bi bi-pencil-square me-2"></i>Edit Application Form
                </h3>
              </div>
              <div class="card-body">
                <p class="text-muted">
                  Edit the application form structure below. You can modify
                  questions, help text, and open/close MOS slots. The form is
                  defined in JSON format.
                </p>

                <form method="POST" action="/apply/admin/edit">
                  <div class="mb-3">
                    <label for="editor" class="form-label"
                      >Form Configuration (JSON)</label
                    >
                    <textarea
                      id="editor"
                      name="questions"
                      class="form-control"
                      required
                    >
<%= JSON.stringify(questions, null, 2) %></textarea
                    >
                  </div>

                  <div class="mb-3">
                    <button
                      type="button"
                      id="previewBtn"
                      class="btn btn-secondary"
                    >
                      <i class="bi bi-eye me-1"></i>Preview Form
                    </button>
                  </div>

                  <div id="previewContainer" class="preview-container d-none">
                    <h4 class="mb-3">Form Preview</h4>
                    <div id="formPreview"></div>
                  </div>

                  <div class="d-flex justify-content-between mt-4">
                    <a href="/apply" class="btn btn-outline-secondary">
                      <i class="bi bi-arrow-left me-1"></i>Back to Applications
                    </a>
                    <button type="submit" class="btn btn-primary">
                      <i class="bi bi-save me-1"></i>Save Changes
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <%- include("../partials/footer") %>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const editor = document.getElementById('editor');
        const previewBtn = document.getElementById('previewBtn');
        const previewContainer = document.getElementById('previewContainer');
        const formPreview = document.getElementById('formPreview');

        previewBtn.addEventListener('click', function () {
          try {
            const questions = JSON.parse(editor.value);
            renderFormPreview(questions);
            previewContainer.classList.remove('d-none');
          } catch (err) {
            formPreview.innerHTML = `<div class="json-error">Error parsing JSON: ${err.message}</div>`;
            previewContainer.classList.remove('d-none');
          }
        });

        function renderFormPreview(questions) {
          let html = '<form class="needs-validation" novalidate>';

          questions.forEach(q => {
            html += `<div class="mb-3">`;
            html += `<label class="form-label" for="${q.id}">${q.label}`;
            if (q.help) {
              html += `<span class="text-muted">${q.help}</span>`;
            }
            html += `</label>`;

            if (q.type === 'text' || q.type === 'number') {
              html += `<input type="${q.type}" id="${q.id}" name="${q.id}" class="form-control" 
                                ${q.required ? 'required' : ''} 
                                ${q.maxlength ? `maxlength="${q.maxlength}"` : ''} 
                                ${q.min ? `min="${q.min}"` : ''} 
                                ${q.max ? `max="${q.max}"` : ''} 
                                placeholder="${q.placeholder || ''}">`;
            } else if (q.type === 'textarea') {
              html += `<textarea id="${q.id}" name="${q.id}" class="form-control" 
                                ${q.required ? 'required' : ''} 
                                ${q.maxlength ? `maxlength="${q.maxlength}"` : ''} 
                                rows="${q.rows || 3}" 
                                placeholder="${q.placeholder || ''}"></textarea>`;
            } else if (q.type === 'select') {
              html += `<select id="${q.id}" name="${q.id}" class="form-select" ${q.required ? 'required' : ''}>`;
              if (q.options && Array.isArray(q.options)) {
                q.options.forEach(opt => {
                  html += `<option value="${opt.value}" ${opt.disabled ? 'disabled' : ''}>${opt.label}</option>`;
                });
              }
              html += `</select>`;
            }

            if (q.help && q.type !== 'select') {
              html += `<div class="form-help">${q.help}</div>`;
            }

            html += `</div>`;
          });

          html += `<button type="button" class="btn btn-primary">Submit Application</button>`;
          html += `</form>`;

          formPreview.innerHTML = html;
        }
      });
    </script>
  </body>
</html>
