<!DOCTYPE html>
<html>
<head>
    <title>Unit Application</title>
    <meta content="1A Website" property="og:title" />
    <meta content="Welcome to 1A!" property="og:description" />
    <meta content="https://1a75.org/apply" property="og:url" />
    <meta content="https://cdn.xanderxx.xyz/1a-logo.png" property="og:image" />
    <meta content="#4b5a2a" data-react-helmet="true" name="theme-color" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="/custom.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        :root {
            --primary-gold: var(--ranger-gold, #e1b84c);
            --secondary-gold: var(--ranger-green, #4b5a2a);
            --dark-gold: var(--ranger-gold, #e1b84c);
            --deep-brown: var(--ranger-red, #b12a2c);
            --pure-black: var(--ranger-bg, #241d1d);
            --bg-gradient: linear-gradient(135deg, var(--ranger-bg, #241d1d) 0%, var(--ranger-footer, #291e1e) 100%);
            --card-bg: var(--ranger-card, #2d2d2d);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --border-light: rgba(225, 184, 76, 0.3);
            --shadow-light: 0 8px 32px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 12px 40px rgba(0, 0, 0, 0.15);
            --shadow-heavy: 0 20px 60px rgba(0, 0, 0, 0.2);
        }

        body {
            background: var(--bg-gradient);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #ffffff;
        }

        .application-container {
            padding: 1rem 0;
        }

        .application-hero {
            background: var(--card-bg);
            border-radius: 24px;
            box-shadow: var(--shadow-heavy);
            overflow: hidden;
            border: 2px solid var(--ranger-gold);
            backdrop-filter: blur(20px);
            position: relative;
            margin-bottom: 3rem;
            padding: 2rem;
            text-align: center;
        }

        .application-hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #FFD700, #DAA520, #B8860B);
        }

        .application-title {
            font-size: 2.2rem;
            font-weight: 800;
            color: var(--primary-gold);
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            line-height: 1.2;
        }

        .application-subtitle {
            font-size: 1.1rem;
            color: #e0e0e0;
            opacity: 0.9;
            margin-bottom: 0;
            line-height: 1.6;
        }

        /* Modern form styling */
        .application-form-card {
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: var(--shadow-heavy);
            border: 2px solid var(--ranger-gold);
            backdrop-filter: blur(20px);
            position: relative;
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .application-form-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #FFD700, #DAA520, #B8860B);
            border-radius: 20px 20px 0 0;
        }

        .form-section-title {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--primary-gold);
            margin-bottom: 1.5rem;
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .form-help {
            font-size: 0.95em;
            color: #e0e0e0;
            margin-top: 0.5rem;
            opacity: 0.8;
        }

        .disabled-form {
            pointer-events: none;
            opacity: 0.6;
        }

        /* Admin section styling */
        .admin-section {
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: var(--shadow-heavy);
            border: 2px solid var(--ranger-gold);
            padding: 2rem;
            position: relative;
            overflow: hidden;
            margin-top: 3rem;
        }

        .admin-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #FFD700, #DAA520, #B8860B);
        }

        .admin-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-gold);
            margin-bottom: 1.5rem;
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .application-card .card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--ranger-gold);
            border-radius: 16px;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-medium);
        }

        .application-card .card:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
            box-shadow: var(--shadow-heavy);
            border-color: var(--ranger-gold);
        }

        .application-card .card-header {
            background: var(--ranger-footer);
            border-bottom: 1px solid var(--ranger-gold);
            color: #ffffff;
        }

        .application-card .card-body {
            background: transparent;
            color: #ffffff;
        }

        .application-card .text-muted {
            color: #e0e0e0 !important;
            opacity: 0.8;
        }

        /* Filter controls */
        .filter-controls {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            border: 1px solid var(--ranger-gold);
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-medium);
        }

        /* Animations */
        .fade-in {
            animation: fadeIn 0.8s ease-out;
        }

        .slide-in {
            animation: slideIn 0.6s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-40px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .application-container {
                padding: 1rem 0;
            }

            .application-hero {
                padding: 1.5rem;
                margin-bottom: 2rem;
            }

            .application-title {
                font-size: 1.8rem;
            }

            .application-subtitle {
                font-size: 1rem;
            }

            .application-form-card {
                margin: 0 0.5rem 2rem 0.5rem;
            }

            .admin-section {
                margin: 2rem 0.5rem 0 0.5rem;
                padding: 1.5rem;
            }

            .filter-controls {
                padding: 1rem;
            }
        }

        @media (max-width: 480px) {
            .application-hero {
                padding: 1rem;
            }

            .application-title {
                font-size: 1.6rem;
            }

            .application-form-card {
                margin: 0 0.2rem 2rem 0.2rem;
            }

            .admin-section {
                margin: 2rem 0.2rem 0 0.2rem;
                padding: 1rem;
            }
        }

        /* Modal styling */
        .modal-content {
            background: var(--card-bg);
            border: 2px solid var(--ranger-gold);
            color: #ffffff;
        }

        .modal-header {
            background: var(--ranger-footer);
            border-bottom: 1px solid var(--ranger-gold);
        }

        .modal-footer {
            background: var(--ranger-footer);
            border-top: 1px solid var(--ranger-gold);
        }
    </style>
</head>
<body>
    <%- include("../partials/navbar", { user, active }) %>
    <div id="main-content">
        <div class="container application-container">
            <!-- Hero Section -->
            <div class="application-hero fade-in">
                <h1 class="application-title">
                    <i class="bi bi-file-earmark-text me-3"></i>
                    Unit Application
                </h1>
                <p class="application-subtitle">
                    Join the elite ranks of 1A. Submit your application to begin your journey with the 75th Ranger Regiment.
                </p>
            </div>

            <!-- Alert Messages -->
            <% if (query && query.alert) { %>
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <%= query.alert %>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            <% } %>
            <% if (query && query.error) { %>
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <%= query.error %>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            <% } %>

            <!-- Application Form -->
            <div class="row justify-content-center">
                <div class="col-12 col-sm-10 col-md-8 col-lg-6">
                    <div class="application-form-card slide-in">
                        <div class="card-body p-4">
                            <h2 class="form-section-title">
                                <i class="bi bi-clipboard-check me-2"></i>Application Form
                            </h2>
                            
                            <% if (isAdmin) { %>
                                <div class="mb-3 text-end">
                                    <a href="/apply/admin/edit" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-pencil-square me-1"></i>Edit Form
                                    </a>
                                </div>
                            <% } %>
                            
                            <% if (alreadyApplied) { %>
                                <div class="alert alert-warning mb-3">
                                    You have already submitted an application. If you need to update your information, please contact an admin.
                                </div>
                            <% } %>
                            
                            <form method="POST" action="/apply" autocomplete="off" <%= alreadyApplied ? 'class="disabled-form"' : '' %>>
                                <% questions.forEach(question => { %>
                                    <div class="mb-3">
                                        <label class="form-label" for="<%= question.id %>">
                                            <%= question.label %>
                                            <% if (question.help && question.type !== 'select') { %>
                                                <span class="text-muted"><%= question.help %></span>
                                            <% } %>
                                        </label>
                                        
                                        <% if (question.type === 'text' || question.type === 'number') { %>
                                            <input 
                                                type="<%= question.type %>" 
                                                id="<%= question.id %>" 
                                                name="<%= question.id %>" 
                                                class="form-control" 
                                                <%= question.required ? 'required' : '' %> 
                                                <%= question.maxlength ? `maxlength="${question.maxlength}"` : '' %> 
                                                <%= question.min ? `min="${question.min}"` : '' %> 
                                                <%= question.max ? `max="${question.max}"` : '' %> 
                                                placeholder="<%= question.placeholder || '' %>" 
                                                <%= alreadyApplied ? 'disabled' : '' %>
                                            >
                                        <% } else if (question.type === 'textarea') { %>
                                            <textarea 
                                                id="<%= question.id %>" 
                                                name="<%= question.id %>" 
                                                class="form-control" 
                                                rows="<%= question.rows || 3 %>" 
                                                <%= question.required ? 'required' : '' %> 
                                                <%= question.maxlength ? `maxlength="${question.maxlength}"` : '' %> 
                                                placeholder="<%= question.placeholder || '' %>" 
                                                <%= alreadyApplied ? 'disabled' : '' %>
                                            ></textarea>
                                        <% } else if (question.type === 'select') { %>
                                            <select 
                                                id="<%= question.id %>" 
                                                name="<%= question.id %>" 
                                                class="form-select" 
                                                <%= question.required ? 'required' : '' %> 
                                                <%= alreadyApplied ? 'disabled' : '' %>
                                            >
                                                <% if (question.options && Array.isArray(question.options)) { %>
                                                    <% question.options.forEach(option => { %>
                                                        <option 
                                                            value="<%= option.value %>" 
                                                            <%= option.disabled ? 'disabled' : '' %>
                                                        ><%= option.label %></option>
                                                    <% }) %>
                                                <% } %>
                                            </select>
                                        <% } %>
                                        
                                        <% if (question.help && (question.type === 'select' || question.type === 'text')) { %>
                                            <div class="form-help"><%- question.help %></div>
                                        <% } %>
                                    </div>
                                <% }) %>
                                
                                <div class="d-flex justify-content-between align-items-center mt-3">
                                    <button type="submit" class="btn btn-primary flex-grow-1 me-2" <%= alreadyApplied ? 'disabled' : '' %>>
                                        <i class="bi bi-send me-1"></i>Submit Application
                                    </button>
                                    <a href="/" class="btn btn-outline-secondary ms-2">
                                        <i class="bi bi-x-circle me-1"></i>Cancel
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <% if (isAdmin && allApplications && allApplications.length) { %>
              <div class="admin-section slide-in">
                <h4 class="admin-title">
                  <i class="bi bi-list-check me-2"></i>Application Management
                </h4>
                
                <!-- Search and Filter Controls -->
                <div class="filter-controls">
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label">Search Applications</label>
                      <input type="text" id="searchApplications" class="form-control" placeholder="Search by username or unit...">
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Filter by Status</label>
                      <select id="statusFilter" class="form-select">
                        <option value="">All Statuses</option>
                        <option value="pending">Pending</option>
                        <option value="approved">Approved</option>
                        <option value="denied">Denied</option>
                      </select>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">&nbsp;</label>
                      <button class="btn btn-outline-secondary w-100 d-block" onclick="clearFilters()">
                        <i class="bi bi-x-circle me-1"></i>Clear Filters
                      </button>
                    </div>
                  </div>
                </div>

                  <!-- Applications Grid -->
                  <div class="row" id="applicationsGrid">
                                         <% allApplications.forEach(app => { %>
                       <div class="col-12 col-md-6 col-lg-4 mb-3 application-card" 
                            data-app-id="<%= app.id %>"
                            data-username="<%= app.username.toLowerCase() %>" 
                            data-unit="<%= app.unit_name.toLowerCase() %>"
                            data-status="<%= app.status %>">
                        <div class="card h-100 shadow-sm border-0">
                          <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 text-truncate">
                              <i class="bi bi-person-circle me-1"></i><%= app.username %>
                            </h6>
                            <span class="badge <%= app.status === 'approved' ? 'bg-success' : app.status === 'denied' ? 'bg-danger' : 'bg-warning text-dark' %>">
                              <%= app.status.charAt(0).toUpperCase() + app.status.slice(1) %>
                            </span>
                          </div>
                          <div class="card-body">
                            <div class="mb-2">
                              <small class="text-muted">Unit Name:</small>
                              <div class="fw-semibold text-truncate"><%= app.unit_name %></div>
                            </div>
                            <div class="mb-2">
                              <small class="text-muted">Reason:</small>
                              <div class="text-truncate" title="<%= app.found_unit %>"><%= app.found_unit %></div>
                            </div>
                            <div class="mb-2">
                              <small class="text-muted">Experience:</small>
                              <div class="text-truncate"><%= app.experience || "—" %></div>
                            </div>
                            <div class="mb-2">
                              <small class="text-muted">MOS:</small>
                              <div class="text-truncate"><%= app.mos || "—" %></div>
                            </div>
                            <div class="mb-3">
                              <small class="text-muted">Submitted:</small>
                              <div class="small"><%= new Date(app.submitted_at).toLocaleDateString() %></div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="d-flex gap-2">
                              <button class="btn btn-sm btn-outline-primary flex-fill" 
                                      onclick="viewApplication('<%= app.id %>')"
                                      title="View Details">
                                <i class="bi bi-eye me-1"></i>View
                              </button>
                              <button class="btn btn-sm btn-outline-warning" 
                                      onclick="editApplication('<%= app.id %>')"
                                      title="Edit Application">
                                <i class="bi bi-pencil-square"></i>
                              </button>
                              <button class="btn btn-sm btn-outline-danger" 
                                      onclick="deleteApplication('<%= app.id %>', '<%= app.username %>')"
                                      title="Delete Application">
                                <i class="bi bi-trash"></i>
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    <% }) %>
                  </div>

                  <!-- No Results Message -->
                  <div id="noResults" class="text-center py-5" style="display: none;">
                    <i class="bi bi-search display-4 text-muted"></i>
                    <h5 class="mt-3 text-muted">No applications found</h5>
                    <p class="text-muted">Try adjusting your search or filter criteria.</p>
                  </div>
                </div>
              </div>

              <!-- Application Details Modal -->
              <div class="modal fade" id="applicationModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title">Application Details</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="modalContent">
                      <!-- Content will be loaded here -->
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                      <button type="button" class="btn btn-warning" id="editModalBtn">
                        <i class="bi bi-pencil-square me-1"></i>Edit
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <script>
                // Search and filter functionality
                document.getElementById('searchApplications').addEventListener('input', filterApplications);
                document.getElementById('statusFilter').addEventListener('change', filterApplications);

                function filterApplications() {
                  const searchTerm = document.getElementById('searchApplications').value.toLowerCase();
                  const statusFilter = document.getElementById('statusFilter').value;
                  const cards = document.querySelectorAll('.application-card');
                  let visibleCount = 0;

                  cards.forEach(card => {
                    const username = card.dataset.username;
                    const unit = card.dataset.unit;
                    const status = card.dataset.status;
                    
                    const matchesSearch = username.includes(searchTerm) || unit.includes(searchTerm);
                    const matchesStatus = !statusFilter || status === statusFilter;
                    
                    if (matchesSearch && matchesStatus) {
                      card.style.display = 'block';
                      visibleCount++;
                    } else {
                      card.style.display = 'none';
                    }
                  });

                  document.getElementById('noResults').style.display = visibleCount === 0 ? 'block' : 'none';
                }

                function clearFilters() {
                  document.getElementById('searchApplications').value = '';
                  document.getElementById('statusFilter').value = '';
                  filterApplications();
                }

                // Application management functions
                function viewApplication(appId) {
                  // Load application details via AJAX or redirect to detail page
                  window.location.href = `/apply/admin/view/${appId}`;
                }

                function editApplication(appId) {
                  // Redirect to edit page
                  window.location.href = `/apply/admin/edit/${appId}`;
                }

                function deleteApplication(appId, username) {
                  if (confirm(`Are you sure you want to delete the application for ${username}? This action cannot be undone.`)) {
                    // Send delete request
                    fetch(`/apply/admin/delete/${appId}`, {
                      method: 'DELETE',
                      headers: {
                        'Content-Type': 'application/json',
                      }
                    })
                    .then(response => response.json())
                    .then(data => {
                      if (data.success) {
                        // Remove the card from the DOM
                        const card = document.querySelector(`[data-app-id="${appId}"]`);
                        if (card) card.remove();
                        
                        // Show success message
                        showAlert('Application deleted successfully', 'success');
                      } else {
                        showAlert('Failed to delete application', 'danger');
                      }
                    })
                    .catch(error => {
                      console.error('Error:', error);
                      showAlert('An error occurred while deleting the application', 'danger');
                    });
                  }
                }

                function showAlert(message, type) {
                  const alertDiv = document.createElement('div');
                  alertDiv.className = `alert alert-${type} alert-dismissible fade show mt-3`;
                  alertDiv.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                  `;
                  
                  const container = document.querySelector('.container');
                  container.insertBefore(alertDiv, container.firstChild);
                  
                  // Auto-dismiss after 5 seconds
                  setTimeout(() => {
                    if (alertDiv.parentNode) {
                      alertDiv.remove();
                    }
                  }, 5000);
                }
              </script>
            <% } %>
        </div>
    </div>
    <%- include("../partials/footer") %>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>