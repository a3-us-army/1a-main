<!DOCTYPE html>
<html>
<head>
    <title>Unit Application</title>
    <meta content="1A Website" property="og:title" />
    <meta content="Welcome to 1A!" property="og:description" />
    <meta content="https://1a75.org/apply" property="og:url" />
    <meta content="https://cdn.xanderxx.xyz/1a-logo.png" property="og:image" />
    <meta content="#4b5a2a" data-react-helmet="true" name="theme-color" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="/custom.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        @media (max-width: 600px) {
            .card {
                padding: 0.5rem;
                margin: 0 0.2rem;
            }
            .card-title {
                font-size: 1.2rem;
            }
            .form-label {
                font-size: 1rem;
            }
            .form-control, .form-select {
                font-size: 1rem;
                padding: 0.6rem 0.7rem;
            }
        }
        .form-help {
            font-size: 0.95em;
            color: #6c757d;
        }
        .card-title i {
            color: #5865f2;
        }
        .disabled-form {
            pointer-events: none;
            opacity: 0.6;
        }
        .table-dark th, .table-dark td {
            color: #fff;
            background-color: #23272f;
        }
        .table-dark thead th {
            background-color: #181a1b;
        }
    </style>
</head>
<body>
    <%- include("../partials/navbar", { user, active }) %>
    <div id="main-content">
        <div class="container mt-4">
            <% if (query && query.alert) { %>
                <div class="alert alert-success alert-dismissible fade show mt-3" role="alert">
                    <%= query.alert %>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            <% } %>
            <% if (query && query.error) { %>
                <div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">
                    <%= query.error %>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            <% } %>
            <div class="row justify-content-center">
                <div class="col-12 col-sm-10 col-md-8 col-lg-6">
                    <div class="card shadow-lg mx-auto">
                        <div class="card-body p-3">
                            <h2 class="card-title mb-3 text-center">
                                <i class="bi bi-file-earmark-text me-2"></i>Unit Application
                            </h2>
                            
                            <% if (isAdmin) { %>
                                <div class="mb-3 text-end">
                                    <a href="/apply/admin/edit" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-pencil-square me-1"></i>Edit Form
                                    </a>
                                </div>
                            <% } %>
                            
                            <% if (alreadyApplied) { %>
                                <div class="alert alert-warning mb-3">
                                    You have already submitted an application. If you need to update your information, please contact an admin.
                                </div>
                            <% } %>
                            
                            <form method="POST" action="/apply" autocomplete="off" <%= alreadyApplied ? 'class="disabled-form"' : '' %>>
                                <% questions.forEach(question => { %>
                                    <div class="mb-3">
                                        <label class="form-label" for="<%= question.id %>">
                                            <%= question.label %>
                                            <% if (question.help && question.type !== 'select') { %>
                                                <span class="text-muted"><%= question.help %></span>
                                            <% } %>
                                        </label>
                                        
                                        <% if (question.type === 'text' || question.type === 'number') { %>
                                            <input 
                                                type="<%= question.type %>" 
                                                id="<%= question.id %>" 
                                                name="<%= question.id %>" 
                                                class="form-control" 
                                                <%= question.required ? 'required' : '' %> 
                                                <%= question.maxlength ? `maxlength="${question.maxlength}"` : '' %> 
                                                <%= question.min ? `min="${question.min}"` : '' %> 
                                                <%= question.max ? `max="${question.max}"` : '' %> 
                                                placeholder="<%= question.placeholder || '' %>" 
                                                <%= alreadyApplied ? 'disabled' : '' %>
                                            >
                                        <% } else if (question.type === 'textarea') { %>
                                            <textarea 
                                                id="<%= question.id %>" 
                                                name="<%= question.id %>" 
                                                class="form-control" 
                                                rows="<%= question.rows || 3 %>" 
                                                <%= question.required ? 'required' : '' %> 
                                                <%= question.maxlength ? `maxlength="${question.maxlength}"` : '' %> 
                                                placeholder="<%= question.placeholder || '' %>" 
                                                <%= alreadyApplied ? 'disabled' : '' %>
                                            ></textarea>
                                        <% } else if (question.type === 'select') { %>
                                            <select 
                                                id="<%= question.id %>" 
                                                name="<%= question.id %>" 
                                                class="form-select" 
                                                <%= question.required ? 'required' : '' %> 
                                                <%= alreadyApplied ? 'disabled' : '' %>
                                            >
                                                <% if (question.options && Array.isArray(question.options)) { %>
                                                    <% question.options.forEach(option => { %>
                                                        <option 
                                                            value="<%= option.value %>" 
                                                            <%= option.disabled ? 'disabled' : '' %>
                                                        ><%= option.label %></option>
                                                    <% }) %>
                                                <% } %>
                                            </select>
                                        <% } %>
                                        
                                        <% if (question.help && (question.type === 'select' || question.type === 'text')) { %>
                                            <div class="form-help"><%- question.help %></div>
                                        <% } %>
                                    </div>
                                <% }) %>
                                
                                <div class="d-flex justify-content-between align-items-center mt-3">
                                    <button type="submit" class="btn btn-primary flex-grow-1 me-2" <%= alreadyApplied ? 'disabled' : '' %>>
                                        <i class="bi bi-send me-1"></i>Submit Application
                                    </button>
                                    <a href="/" class="btn btn-outline-secondary ms-2">
                                        <i class="bi bi-x-circle me-1"></i>Cancel
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <% if (isAdmin && allApplications && allApplications.length) { %>
              <div class="row justify-content-center mt-5">
                <div class="col-12 col-lg-10">
                  <h4 class="mb-3 text-center"><i class="bi bi-list-check me-1"></i> All Applications</h4>
                  
                  <!-- Search and Filter Controls -->
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <input type="text" id="searchApplications" class="form-control" placeholder="Search applications...">
                    </div>
                    <div class="col-md-3">
                      <select id="statusFilter" class="form-select">
                        <option value="">All Statuses</option>
                        <option value="pending">Pending</option>
                        <option value="approved">Approved</option>
                        <option value="denied">Denied</option>
                      </select>
                    </div>
                    <div class="col-md-3">
                      <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                        <i class="bi bi-x-circle me-1"></i>Clear Filters
                      </button>
                    </div>
                  </div>

                  <!-- Applications Grid -->
                  <div class="row" id="applicationsGrid">
                                         <% allApplications.forEach(app => { %>
                       <div class="col-12 col-md-6 col-lg-4 mb-3 application-card" 
                            data-app-id="<%= app.id %>"
                            data-username="<%= app.username.toLowerCase() %>" 
                            data-unit="<%= app.unit_name.toLowerCase() %>"
                            data-status="<%= app.status %>">
                        <div class="card h-100 shadow-sm border-0">
                          <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 text-truncate">
                              <i class="bi bi-person-circle me-1"></i><%= app.username %>
                            </h6>
                            <span class="badge <%= app.status === 'approved' ? 'bg-success' : app.status === 'denied' ? 'bg-danger' : 'bg-warning text-dark' %>">
                              <%= app.status.charAt(0).toUpperCase() + app.status.slice(1) %>
                            </span>
                          </div>
                          <div class="card-body">
                            <div class="mb-2">
                              <small class="text-muted">Unit Name:</small>
                              <div class="fw-semibold text-truncate"><%= app.unit_name %></div>
                            </div>
                            <div class="mb-2">
                              <small class="text-muted">Reason:</small>
                              <div class="text-truncate" title="<%= app.found_unit %>"><%= app.found_unit %></div>
                            </div>
                            <div class="mb-2">
                              <small class="text-muted">Experience:</small>
                              <div class="text-truncate"><%= app.experience || "—" %></div>
                            </div>
                            <div class="mb-2">
                              <small class="text-muted">MOS:</small>
                              <div class="text-truncate"><%= app.mos || "—" %></div>
                            </div>
                            <div class="mb-3">
                              <small class="text-muted">Submitted:</small>
                              <div class="small"><%= new Date(app.submitted_at).toLocaleDateString() %></div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="d-flex gap-2">
                              <button class="btn btn-sm btn-outline-primary flex-fill" 
                                      onclick="viewApplication('<%= app.id %>')"
                                      title="View Details">
                                <i class="bi bi-eye me-1"></i>View
                              </button>
                              <button class="btn btn-sm btn-outline-warning" 
                                      onclick="editApplication('<%= app.id %>')"
                                      title="Edit Application">
                                <i class="bi bi-pencil-square"></i>
                              </button>
                              <button class="btn btn-sm btn-outline-danger" 
                                      onclick="deleteApplication('<%= app.id %>', '<%= app.username %>')"
                                      title="Delete Application">
                                <i class="bi bi-trash"></i>
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    <% }) %>
                  </div>

                  <!-- No Results Message -->
                  <div id="noResults" class="text-center py-5" style="display: none;">
                    <i class="bi bi-search display-4 text-muted"></i>
                    <h5 class="mt-3 text-muted">No applications found</h5>
                    <p class="text-muted">Try adjusting your search or filter criteria.</p>
                  </div>
                </div>
              </div>

              <!-- Application Details Modal -->
              <div class="modal fade" id="applicationModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title">Application Details</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="modalContent">
                      <!-- Content will be loaded here -->
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                      <button type="button" class="btn btn-warning" id="editModalBtn">
                        <i class="bi bi-pencil-square me-1"></i>Edit
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <script>
                // Search and filter functionality
                document.getElementById('searchApplications').addEventListener('input', filterApplications);
                document.getElementById('statusFilter').addEventListener('change', filterApplications);

                function filterApplications() {
                  const searchTerm = document.getElementById('searchApplications').value.toLowerCase();
                  const statusFilter = document.getElementById('statusFilter').value;
                  const cards = document.querySelectorAll('.application-card');
                  let visibleCount = 0;

                  cards.forEach(card => {
                    const username = card.dataset.username;
                    const unit = card.dataset.unit;
                    const status = card.dataset.status;
                    
                    const matchesSearch = username.includes(searchTerm) || unit.includes(searchTerm);
                    const matchesStatus = !statusFilter || status === statusFilter;
                    
                    if (matchesSearch && matchesStatus) {
                      card.style.display = 'block';
                      visibleCount++;
                    } else {
                      card.style.display = 'none';
                    }
                  });

                  document.getElementById('noResults').style.display = visibleCount === 0 ? 'block' : 'none';
                }

                function clearFilters() {
                  document.getElementById('searchApplications').value = '';
                  document.getElementById('statusFilter').value = '';
                  filterApplications();
                }

                // Application management functions
                function viewApplication(appId) {
                  // Load application details via AJAX or redirect to detail page
                  window.location.href = `/apply/admin/view/${appId}`;
                }

                function editApplication(appId) {
                  // Redirect to edit page
                  window.location.href = `/apply/admin/edit/${appId}`;
                }

                function deleteApplication(appId, username) {
                  if (confirm(`Are you sure you want to delete the application for ${username}? This action cannot be undone.`)) {
                    // Send delete request
                    fetch(`/apply/admin/delete/${appId}`, {
                      method: 'DELETE',
                      headers: {
                        'Content-Type': 'application/json',
                      }
                    })
                    .then(response => response.json())
                    .then(data => {
                      if (data.success) {
                        // Remove the card from the DOM
                        const card = document.querySelector(`[data-app-id="${appId}"]`);
                        if (card) card.remove();
                        
                        // Show success message
                        showAlert('Application deleted successfully', 'success');
                      } else {
                        showAlert('Failed to delete application', 'danger');
                      }
                    })
                    .catch(error => {
                      console.error('Error:', error);
                      showAlert('An error occurred while deleting the application', 'danger');
                    });
                  }
                }

                function showAlert(message, type) {
                  const alertDiv = document.createElement('div');
                  alertDiv.className = `alert alert-${type} alert-dismissible fade show mt-3`;
                  alertDiv.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                  `;
                  
                  const container = document.querySelector('.container');
                  container.insertBefore(alertDiv, container.firstChild);
                  
                  // Auto-dismiss after 5 seconds
                  setTimeout(() => {
                    if (alertDiv.parentNode) {
                      alertDiv.remove();
                    }
                  }, 5000);
                }
              </script>
            <% } %>
        </div>
    </div>
    <%- include("../partials/footer") %>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>