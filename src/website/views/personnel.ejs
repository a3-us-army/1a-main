<!DOCTYPE html>
<html>
  <head>
    <title>PERSTAT</title>
    <meta content="1A Website" property="og:title" />
    <meta content="Welcome to 1A!" property="og:description" />
    <meta content="https://1a75.org/personnel" property="og:url" />
    <meta content="https://cdn.xanderxx.xyz/1a-logo.png" property="og:image" />
    <meta content="#4b5a2a" data-react-helmet="true" name="theme-color" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta name="version" content="2024-01-27-v3" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/custom.css?v=2" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <style>
      .platoon-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #ffe066;
        margin-bottom: 0.5rem;
        margin-top: 2rem;
      }
      .table-dark th,
      .table-dark td {
        color: #fff;
        background-color: #23272f;
      }
      .table-dark thead th {
        background-color: #181a1b;
      }
      .badge-reserve {
        background: #1a237e !important;
        color: #fff !important;
      }
      @media (max-width: 600px) {
        .platoon-title {
          font-size: 1.1rem;
          margin-top: 1.2rem;
        }
        .table-responsive {
          font-size: 0.95rem;
        }
      }
    </style>
  </head>
  <body>
    <%- include("partials/navbar", { user, active }) %>
    <div class="container mt-5" id="main-content">
      <h2 class="mb-4 text-center">
        <i class="bi bi-people me-2"></i>All Personnel
      </h2>
      <div id="platoon-sections">
        <!-- Sections will be rendered here by JS -->
      </div>
      <div id="aviation-section" class="mt-5"></div>
    </div>
    <%- include("partials/footer") %>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js?v=2"></script>
    <script>
      // Helper: Determine which main group a section belongs to
      function getSectionType(sectionName) {
        if (!sectionName) return 'other';
        const name = sectionName.toLowerCase();

        // Command: HQ and Platoon Command
        if (
          name.includes('hq') ||
          name === '1st platoon, alpha company' ||
          name === 'alpha company headquarters'
        ) {
          return 'command';
        }

        // Platoon: All squads (except HQ, support, etc.)
        if (
          name.includes('squad') ||
          name.includes('weapons') ||
          name.includes('security')
        ) {
          return 'platoon';
        }

        // Support: Fires, Sniper, Reserves, etc.
        if (
          name.includes('fires cell') ||
          name.includes('sniper') ||
          name.includes('reserves') ||
          name.includes('mortar') ||
          name.includes('support')
        ) {
          return 'support';
        }

        // Default fallback
        return 'other';
      }

      // Section header: only position is filled
      function isSectionHeader(row) {
        return (
          row.position &&
          (!row.callsign || row.callsign.trim() === '') &&
          (!row.status || row.status.trim() === '') &&
          (!row.name || row.name.trim() === '')
        );
      }

      async function loadPersonnelCards() {
        const res = await fetch('/personnel/api/personnel');
        const personnel = await res.json();
        const container = document.getElementById('platoon-sections');
        let html = '';

        if (!Array.isArray(personnel) || personnel.length === 0) {
          html = `<div class="alert alert-info text-center">No personnel data found.</div>`;
        } else {
          // Group personnel by section
          const sections = [];
          let currentSection = null;

          personnel.forEach(row => {
            if (isSectionHeader(row)) {
              currentSection = {
                name: row.position,
                members: [],
              };
              sections.push(currentSection);
            } else if (currentSection) {
              currentSection.members.push(row);
            }
          });

          // Organize sections into main groups
          const groups = {
            command: [],
            platoon: [],
            support: [],
            other: [],
          };

          sections.forEach(section => {
            const type = getSectionType(section.name);
            groups[type] = groups[type] || [];
            groups[type].push(section);
          });

          // Helper: Card color classes
          const cardStyles = {
            command: {
              border: 'border-success',
              text: 'text-success',
              icon: 'bi-shield-lock-fill',
            },
            platoon: {
              border: 'border-primary',
              text: 'text-primary',
              icon: 'bi-people-fill',
            },
            support: {
              border: 'border-info',
              text: 'text-info',
              icon: 'bi-truck',
            },
            other: {
              border: 'border-secondary',
              text: 'text-secondary',
              icon: 'bi-question-circle',
            },
          };

          // Render each group
          function renderGroup(title, type) {
            if (!groups[type] || groups[type].length === 0) return '';
            let groupHtml = `
          <div class="col-12">
            <h3 class="mb-3 mt-4 ${cardStyles[type].text}">
              <i class="bi ${cardStyles[type].icon} me-2"></i>${title}
            </h3>
          </div>
        `;
            // Render each section as a card
            groups[type].forEach(section => {
              groupHtml += `
            <div class="col-12 col-md-6 col-lg-4">
              <div class="card shadow h-100 ${cardStyles[type].border} border-2">
                <div class="card-header bg-dark $type{cardStyles[type].text} fw-bold">
                  <i class="bi ${cardStyles[type].icon} me-2"></i>${section.name}
                </div>
                <div class="card-body p-0">
                  <div class="table-responsive">
                    <table class="table table-dark table-striped table-bordered table-hover table-sm align-middle mb-0">
                      <thead style="background: #181a1b;">
                        <tr>
                          <th>Position</th>
                          <th>Callsign</th>
                          <th>Status</th>
                          <th>Name</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${
                          section.members.length === 0
                            ? `<tr><td colspan="4" class="text-center text-muted">No members</td></tr>`
                            : section.members
                                .map(
                                  row => `
                              <tr>
                                <td>${row.position || ''}</td>
                                <td>${row.callsign || ''}</td>
                                <td>
                                  ${
                                    row.status === 'Active'
                                      ? `<span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Active</span>`
                                      : row.status === 'Empty'
                                        ? `<span class="badge bg-secondary"><i class="bi bi-dash-circle me-1"></i>Empty</span>`
                                        : row.status === 'Closed'
                                          ? `<span class="badge bg-danger"><i class="bi bi-x-circle me-1"></i>Closed</span>`
                                          : row.status === 'LOA'
                                            ? `<span class="badge bg-warning text-dark"><i class="bi bi-exclamation-circle me-1"></i>LOA</span>`
                                            : row.status
                                              ? `<span class="badge bg-warning text-dark"><i class="bi bi-exclamation-circle me-1"></i>${row.status}</span>`
                                              : ''
                                  }
                                </td>
                                <td>${row.name || ''}</td>
                              </tr>
                            `
                                )
                                .join('')
                        }
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          `;
            });
            return groupHtml;
          }

          html += `<div class="row g-4">`;
          html += renderGroup('Command', 'command');
          html += renderGroup('Platoon', 'platoon');
          html += renderGroup('Support', 'support');
          html += renderGroup('Other', 'other');
          html += `</div>`;
        }
        container.innerHTML = html;
      }

      document.addEventListener('DOMContentLoaded', loadPersonnelCards);
    </script>
    <script>
      async function loadAviationTable() {
        const res = await fetch('/personnel/api/aviation');
        const aviation = await res.json();
        const container = document.getElementById('aviation-section');
        let html = '';

        if (!Array.isArray(aviation) || aviation.length === 0) {
          html = `<div class="alert alert-info text-center">No aviation data found.</div>`;
        } else {
          // Group by section header (TF160th, AvTEG)
          const groups = [];
          let currentGroup = null;

          aviation.forEach(row => {
            const isHeader =
              row.position &&
              (!row.status || row.status.trim() === '') &&
              (!row.name || row.name.trim() === '');

            if (isHeader) {
              currentGroup = {
                name: row.position,
                members: [],
              };
              groups.push(currentGroup);
            } else if (currentGroup) {
              currentGroup.members.push(row);
            }
          });

          html += `
        <div class="row g-4">
          <div class="col-12">
            <h3 class="mb-3 mt-4 text-info">
              <i class="bi bi-airplane me-2"></i>Aviation
            </h3>
          </div>
          ${groups
            .map(
              group => `
            <div class="col-12 col-md-6">
              <div class="card shadow h-100 border-info border-2">
                <div class="card-header bg-dark text-info fw-bold">
                  <i class="${
                    group.name.toLowerCase().includes('160')
                      ? 'fa-solid fa-helicopter'
                      : 'fa-solid fa-plane'
                  } me-2"></i>${group.name}
                </div>
                <div class="card-body p-0">
                  <div class="table-responsive">
                    <table class="table table-dark table-striped table-bordered table-hover table-sm align-middle mb-0">
                      <thead style="background: #181a1b;">
                        <tr>
                          <th>Position</th>
                          <th>Status</th>
                          <th>Name</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${
                          group.members.length === 0
                            ? `<tr><td colspan="3" class="text-center text-muted">No members</td></tr>`
                            : group.members
                                .map(
                                  row => `
                            <tr>
                              <td>${row.position || ''}</td>
                              <td>
                                ${
                                  row.status === 'Active'
                                    ? `<span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Active</span>`
                                    : row.status === 'Empty'
                                      ? `<span class="badge bg-secondary"><i class="bi bi-dash-circle me-1"></i>Empty</span>`
                                      : row.status === 'Closed'
                                        ? `<span class="badge bg-danger"><i class="bi bi-x-circle me-1"></i>Closed</span>`
                                        : row.status === 'LOA'
                                          ? `<span class="badge bg-warning text-dark"><i class="bi bi-exclamation-circle me-1"></i>LOA</span>`
                                          : row.status
                                            ? `<span class="badge bg-warning text-dark"><i class="bi bi-exclamation-circle me-1"></i>${row.status}</span>`
                                            : ''
                                }
                              </td>
                              <td>${row.name || ''}</td>
                            </tr>
                          `
                                )
                                .join('')
                        }
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          `
            )
            .join('')}
        </div>
      `;
        }
        container.innerHTML = html;
      }
      document.addEventListener('DOMContentLoaded', loadAviationTable);
    </script>
  </body>
</html>
